-- Services
local Players = game:GetService("Players")
local ContextActionService = game:GetService("ContextActionService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local TeamsService = game:GetService("Teams")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local workspaceRemote = workspace:WaitForChild("Remote")

-- helper to create instances
local function new(class, props, parent)
    local obj = Instance.new(class)
    if props then
        for k,v in pairs(props) do obj[k] = v end
    end
    if parent then obj.Parent = parent end
    return obj
end

-- Root
local screenGui = new("ScreenGui", {Name = "BMF_UI_ThemeA", ResetOnSpawn = false}, playerGui)

-- Main container
local main = new("Frame", {
    Name = "Main",
    Size = UDim2.new(0,520,0,520),
    Position = UDim2.new(0.5,-260,0.5,-260),
    BackgroundColor3 = Color3.fromRGB(28,28,28),
    BorderSizePixel = 0,
}, screenGui)
new("UICorner", {CornerRadius = UDim.new(0,10)}, main)
new("UIStroke", {Color = Color3.fromRGB(22,22,22), Thickness = 1, Transparency = 0.9}, main)

-- Title bar
local titleBar = new("Frame", {Parent = main, Size = UDim2.new(1,0,0,48), BackgroundColor3 = Color3.fromRGB(40,40,40)}, main)
new("UICorner", {CornerRadius = UDim.new(0,8)}, titleBar)
local titleLabel = new("TextLabel", {
    Parent = titleBar,
    Text = "Prison Life - BMF",
    BackgroundTransparency = 1,
    Size = UDim2.new(1,-120,1,0),
    Position = UDim2.new(0,16,0,0),
    Font = Enum.Font.GothamBold,
    TextSize = 20,
    TextColor3 = Color3.fromRGB(255,255,255),
    TextXAlignment = Enum.TextXAlignment.Left,
}, titleBar)

-- Minimize/Maximize
local toggleBtn = new("TextButton", {
    Parent = titleBar,
    Size = UDim2.new(0,96,0,30),
    Position = UDim2.new(1,-110,0,9),
    Text = "Minimize",
    Font = Enum.Font.Gotham,
    TextSize = 14,
    TextColor3 = Color3.fromRGB(255,255,255),
    BackgroundColor3 = Color3.fromRGB(65,65,65),
    BorderSizePixel = 0,
}, titleBar)
new("UICorner", {CornerRadius = UDim.new(0,6)}, toggleBtn)

-- Error log (single-line)
local errFrame = new("Frame", {
    Parent = main,
    Size = UDim2.new(1,-24,0,30),
    Position = UDim2.new(0,12,0,56),
    BackgroundColor3 = Color3.fromRGB(44,44,44),
    BorderSizePixel = 0,
}, main)
new("UICorner", {CornerRadius = UDim.new(0,6)}, errFrame)
local errLabel = new("TextLabel", {
    Parent = errFrame,
    Text = "Error Log: None",
    BackgroundTransparency = 1,
    Size = UDim2.new(1,-12,1,0),
    Position = UDim2.new(0,6,0,0),
    Font = Enum.Font.Gotham,
    TextSize = 14,
    TextColor3 = Color3.fromRGB(255,100,100),
    TextXAlignment = Enum.TextXAlignment.Left,
    TextTruncate = Enum.TextTruncate.AtEnd,
}, errFrame)

local function setError(text)
    pcall(function() errLabel.Text = "Error Log: " .. tostring(text or "None") end)
end

-- Divider
local divider = new("Frame", {
    Parent = main,
    Size = UDim2.new(0,2,1,-118),
    Position = UDim2.new(0,152,0,90),
    BackgroundColor3 = Color3.fromRGB(75,75,75),
}, main)

-- Tabs panel (left)
local tabsPanel = new("Frame", {
    Parent = main,
    Size = UDim2.new(0,152,1,-118),
    Position = UDim2.new(0,0,0,90),
    BackgroundTransparency = 1,
}, main)
local tabsLayout = new("UIListLayout", {Padding = UDim.new(0,8), SortOrder = Enum.SortOrder.LayoutOrder}, tabsPanel)
new("UIPadding", {PaddingLeft = UDim.new(0,12), PaddingTop = UDim.new(0,8)}, tabsPanel)

-- Buttons panel (right scrollable) - shifted slightly left for cleaner look
local buttonsPanel = new("ScrollingFrame", {
    Parent = main,
    Name = "ButtonsPanel",
    Size = UDim2.new(1,-180,1,-118),
    Position = UDim2.new(0,176,0,90),
    BackgroundTransparency = 1,
    CanvasSize = UDim2.new(0,0,0,0),
    ScrollBarThickness = 8,
}, main)
local buttonsLayout = new("UIListLayout", {Padding = UDim.new(0,8), SortOrder = Enum.SortOrder.LayoutOrder}, buttonsPanel)
new("UIPadding", {PaddingLeft = UDim.new(0,4), PaddingRight = UDim.new(0,8), PaddingTop = UDim.new(0,8)}, buttonsPanel)

local function updateCanvas()
    RunService.Heartbeat:Wait()
    buttonsPanel.CanvasSize = UDim2.new(0,0,0, buttonsLayout.AbsoluteContentSize.Y + 12)
end

-- Button factory (hover, click wrapper)
local function makeButton(text, parent, callback)
    local btn = new("TextButton", {
        Parent = parent,
        Size = UDim2.new(1,0,0,40),
        BackgroundColor3 = Color3.fromRGB(72,72,72),
        BorderSizePixel = 0,
        Font = Enum.Font.Gotham,
        TextSize = 15,
        TextColor3 = Color3.fromRGB(255,255,255),
        Text = text,
        AutoButtonColor = false,
    }, parent)
    new("UICorner", {CornerRadius = UDim.new(0,6)}, btn)
    btn.MouseEnter:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.12), {BackgroundColor3 = Color3.fromRGB(92,92,92)}):Play()
    end)
    btn.MouseLeave:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.12), {BackgroundColor3 = Color3.fromRGB(72,72,72)}):Play()
    end)
    btn.MouseButton1Click:Connect(function()
        local ok, err = pcall(callback)
        if not ok then setError(err) end
    end)
    return btn
end

local function clearButtons()
    for _,c in ipairs(buttonsPanel:GetChildren()) do
        if c:IsA("TextButton") then c:Destroy() end
    end
end

-- Player state
local noclipActive = false
local infiniteJumpActive = false
local flyingActive = false
local flyBV, flyBG = nil, nil
local moveKeys = {W=false, A=false, S=false, D=false}
local baseFlySpeed = 60

-- Draggable (global)
local dragging = false
local dragStart, startPos
local UIS = UserInputService
local function updateDrag(input)
    local delta = input.Position - dragStart
    main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

main.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = main.Position
    end
end)
UIS.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        updateDrag(input)
    end
end)
UIS.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

-- Minimize / Maximize behavior
local minimized = false
local origSize = main.Size
toggleBtn.MouseButton1Click:Connect(function()
    if minimized then
        minimized = false
        toggleBtn.Text = "Minimize"
        errFrame.Visible = true
        buttonsPanel.Visible = true
        divider.Visible = true
        TweenService:Create(main, TweenInfo.new(0.16, Enum.EasingStyle.Quad), {Size = origSize}):Play()
    else
        minimized = true
        toggleBtn.Text = "Maximize"
        errFrame.Visible = false
        buttonsPanel.Visible = false
        divider.Visible = false
        TweenService:Create(main, TweenInfo.new(0.16, Enum.EasingStyle.Quad), {Size = UDim2.new(origSize.X.Scale, origSize.X.Offset, 0, 48)}):Play()
    end
end)

-- Toggle UI with Delete
local visible = true
local function setVisible(v)
    visible = v
    if v then
        main.Visible = true
        main.Position = UDim2.new(0.5, -260, 0.5, -260 + 12)
        TweenService:Create(main, TweenInfo.new(0.18, Enum.EasingStyle.Quad), {Position = UDim2.new(0.5, -260, 0.5, -260)}):Play()
    else
        TweenService:Create(main, TweenInfo.new(0.12, Enum.EasingStyle.Quad), {Position = UDim2.new(0.5, -260, 0.5, -260 + 12)}):Play()
        spawn(function() wait(0.14) main.Visible = false end)
    end
end

ContextActionService:BindAction("BMF_TOGGLE_UI", function(_, state)
    if state == Enum.UserInputState.Begin then
        setVisible(not visible)
        setError(visible and "Menu opened" or "Menu closed")
    end
    return Enum.ContextActionResult.Sink
end, false, Enum.KeyCode.Delete)

-- WASD fly input
UIS.InputBegan:Connect(function(input, typing)
    if typing then return end
    if input.UserInputType == Enum.UserInputType.Keyboard then
        local k = input.KeyCode.Name
        if k == "W" or k == "A" or k == "S" or k == "D" then moveKeys[k] = true end
        if k == "LeftShift" or k == "RightShift" then baseFlySpeed = 120 end
    end
end)
UIS.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Keyboard then
        local k = input.KeyCode.Name
        if k == "W" or k == "A" or k == "S" or k == "D" then moveKeys[k] = false end
        if k == "LeftShift" or k == "RightShift" then baseFlySpeed = 60 end
    end
end)

local function flyDirectionFromKeys()
    local cam = workspace.CurrentCamera
    if not cam then return Vector3.new() end
    local forward = cam.CFrame.LookVector
    local right = cam.CFrame.RightVector
    local dir = Vector3.new()
    if moveKeys.W then dir = dir + Vector3.new(forward.X, 0, forward.Z) end
    if moveKeys.S then dir = dir - Vector3.new(forward.X, 0, forward.Z) end
    if moveKeys.D then dir = dir + Vector3.new(right.X, 0, right.Z) end
    if moveKeys.A then dir = dir - Vector3.new(right.X, 0, right.Z) end
    if dir.Magnitude > 0 then return dir.Unit end
    return Vector3.new()
end

-- Run loops: noclip + fly
RunService.Stepped:Connect(function()
    if noclipActive and player.Character then
        for _,p in ipairs(player.Character:GetDescendants()) do
            if p:IsA("BasePart") then p.CanCollide = false end
        end
    end
end)

RunService.RenderStepped:Connect(function()
    if flyingActive and player.Character and flyBV and flyBG then
        local dir = flyDirectionFromKeys()
        if dir.Magnitude > 0 then
            flyBV.Velocity = Vector3.new(dir.X, 0, dir.Z) * baseFlySpeed
        else
            flyBV.Velocity = Vector3.new(0, 0, 0)
        end
        local root = player.Character:GetPrimaryPartCFrame()
        local cam = workspace.CurrentCamera
        if cam then flyBG.CFrame = CFrame.new(root.p, root.p + cam.CFrame.LookVector) end
    end
end)

-- Infinite jump
UserInputService.JumpRequest:Connect(function()
    if infiniteJumpActive and player.Character then
        local hum = player.Character:FindFirstChildOfClass("Humanoid")
        if hum then hum:ChangeState(Enum.HumanoidStateType.Jumping) end
    end
end)

-- Tab populators
local function populatePlayerTab()
    clearButtons()
    makeButton("Noclip", buttonsPanel, function() noclipActive = true; setError("Noclip ON") end)
    makeButton("Unclip", buttonsPanel, function() noclipActive = false; if player.Character then for _,p in ipairs(player.Character:GetDescendants()) do if p:IsA("BasePart") then p.CanCollide = true end end end; setError("Noclip OFF") end)
    makeButton("Fly", buttonsPanel, function()
        if flyingActive then setError("Already flying"); return end
        local char = player.Character
        if not char then setError("No character"); return end
        local root = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChildWhichIsA("BasePart")
        if not root then setError("No root"); return end
        flyingActive = true
        flyBV = Instance.new("BodyVelocity", root); flyBV.MaxForce = Vector3.new(1e6,1e6,1e6)
        flyBG = Instance.new("BodyGyro", root); flyBG.MaxTorque = Vector3.new(1e6,1e6,1e6)
        setError("Fly ON (WASD to move, Shift to boost)")
    end)
    makeButton("Unfly", buttonsPanel, function() flyingActive = false; if flyBV then flyBV:Destroy(); flyBV=nil end; if flyBG then flyBG:Destroy(); flyBG=nil end; setError("Fly OFF") end)
    makeButton("Infinite Jump (toggle)", buttonsPanel, function() infiniteJumpActive = not infiniteJumpActive; setError("Infinite Jump "..(infiniteJumpActive and "ON" or "OFF")) end)
    makeButton("Speed Hack (50)", buttonsPanel, function() local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid"); if hum then hum.WalkSpeed = 50; setError("WalkSpeed = 50") else setError("Humanoid missing") end end)
    makeButton("Reset Character", buttonsPanel, function()
        local char = player.Character
        if char then local hum = char:FindFirstChildOfClass("Humanoid") if hum and hum.Health>0 then hum.Health = 0; setError("Character reset") return end end
        local ok, err = pcall(function() player:LoadCharacter() end)
        if ok then setError("Character loaded") else setError("Reset error: "..tostring(err)) end
    end)
    updateCanvas()
end

local function populateMiscTab()
    clearButtons()
    makeButton("Remove Doors", buttonsPanel, function()
        if workspace:FindFirstChild("Doors") then workspace.Doors:Destroy(); setError("Doors removed") else setError("No Doors found") end
    end)
    makeButton("Remove Walls", buttonsPanel, function()
        if workspace:FindFirstChild("walls") then workspace.walls:Destroy(); setError("Walls removed") else setError("No Walls found") end
    end)
    makeButton("Rejoin Server", buttonsPanel, function()
        setError("Rejoining server...")
        local TeleportService = game:GetService("TeleportService")
        local placeId = game.PlaceId
        TeleportService:Teleport(placeId, player)
    end)
    updateCanvas()
end

local function populateCheatsTab()
    clearButtons()
    makeButton("ESP (Inmates, Guards, Criminals)", buttonsPanel, function()
        setError("ESP Enabled")
        local function espPlayer(p)
            if p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                for _,part in ipairs(p.Character:GetDescendants()) do
                    if part:IsA("BasePart") then
                        local outline = Instance.new("SelectionBox")
                        outline.Adornee = part
                        outline.LineThickness = 0.05
                        outline.SurfaceColor3 = p.TeamColor.Color
                        outline.Color3 = p.TeamColor.Color
                        outline.Parent = part
                    end
                end
            end
        end
        for _,p in ipairs(Players:GetPlayers()) do
            if p ~= player then espPlayer(p) end
            p.CharacterAdded:Connect(function() espPlayer(p) end)
        end
    end)
    updateCanvas()
end

local function populateTeleportsTab()
    clearButtons()
    local teleports = {
        ["Armoury"] = Vector3.new(830, 100, 2239),
        ["Yard"] = Vector3.new(795, 98, 2470),
        ["Nexus"] = Vector3.new(912, 100, 2375),
        ["Cafeteria"] = Vector3.new(903, 100, 2320),
        ["Cell Block"] = Vector3.new(916, 100, 2447),
        ["Lobby"] = Vector3.new(704, 100, 2274),
        ["Garage"] = Vector3.new(616, 98, 2475),
        ["Tower"] = Vector3.new(823, 126, 2589),
        ["Roof"] = Vector3.new(822, 119, 2321),
        ["Sewer"] = Vector3.new(917, 98, 2102),
        ["Gate"] = Vector3.new(496, 98, 2216),
        ["Criminal Base"] = Vector3.new(-932, 94, 2051),
        ["Neutral Spawn"] = Vector3.new(864, 40, 2342),
    }
    for name,pos in pairs(teleports) do
        makeButton(name, buttonsPanel, function()
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                player.Character.HumanoidRootPart.CFrame = CFrame.new(pos)
                setError("Teleported to "..name)
            end
        end)
    end
    updateCanvas()
end

local function populateScriptsTab()
    clearButtons()
    makeButton("Infinite Yield", buttonsPanel, function()
        setError("Running Infinite Yield...")
        local ok, err = pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source"))() end)
        if ok then setError("Infinite Yield OK") else setError("InfiniteYield err: "..tostring(err)) end
    end)
    makeButton("Dex Explorer", buttonsPanel, function()
        setError("Running Dex Explorer...")
        local ok, err = pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/infyiff/backup/main/dex.lua"))() end)
        if ok then setError("Dex OK") else setError("Dex err: "..tostring(err)) end
    end)
    makeButton("Chat Bypass", buttonsPanel, function()
        setError("Running Chat Bypass...")
        local ok, err = pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/AnnaRoblox/AnnaBypasser/refs/heads/main/AnnaBypasser.lua", true))() end)
        if ok then setError("Chat Bypass OK") else setError("Chat err: "..tostring(err)) end
    end)
    updateCanvas()
end

local function populateGeneric()
    clearButtons()
    for i=1,6 do makeButton("WIP!", buttonsPanel, function() end) end
    updateCanvas()
end

-- Create tab buttons (Removed Teams)
local tabNames = {"Player","Teleports","Cheats","Misc","Scripts","Weapons"}
local tabButtons = {}
for _,name in ipairs(tabNames) do
    local tbtn = new("TextButton", {
        Parent = tabsPanel,
        Size = UDim2.new(1,-24,0,40),
        BackgroundColor3 = Color3.fromRGB(55,55,55),
        Text = name,
        Font = Enum.Font.Gotham,
        TextSize = 15,
        TextColor3 = Color3.fromRGB(255,255,255),
    }, tabsPanel)
    new("UICorner", {CornerRadius = UDim.new(0,6)}, tbtn)
    tbtn.MouseButton1Click:Connect(function()
        for _,c in ipairs(tabsPanel:GetChildren()) do if c:IsA("TextButton") then c.BackgroundColor3 = Color3.fromRGB(55,55,55) end end
        tbtn.BackgroundColor3 = Color3.fromRGB(92,92,92)
        if name == "Player" then populatePlayerTab()
        elseif name == "Misc" then populateMiscTab()
        elseif name == "Teleports" then populateTeleportsTab()
        elseif name == "Cheats" then populateCheatsTab()
        elseif name == "Scripts" then populateScriptsTab()
        else populateGeneric() end
    end)
    table.insert(tabButtons, tbtn)
end

-- Default open Player tab
for _,tbtn in ipairs(tabButtons) do
    if tbtn.Text == "Player" then
        tbtn:CaptureFocus()
        tbtn:MouseButton1Click()
        tbtn.BackgroundColor3 = Color3.fromRGB(92,92,92)
        break
    end
end

-- Finalize
updateCanvas()
setError("BMF UI Loaded!")
main.Visible = true
print("BMF UI loaded!")
